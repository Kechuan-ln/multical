# GoPro + PrimeColor 多相机同步完整流程

## 概览

本工作流程实现了16个GoPro相机 + 1个PrimeColor相机 + Mocap数据的完全自动化同步。

**核心特点**：
- ✅ 使用QR码anchor视频作为绝对时间基准
- ✅ 不需要共同QR码（每个视频单独与anchor对齐）
- ✅ 支持不同FPS的相机（GoPro 60fps, PrimeColor 120fps）
- ✅ 自动生成堆叠视频用于可视化验证
- ✅ 同步Mocap CSV数据

---

## 完整工作流程

### 步骤0: 自动检测数据结构

扫描输入目录，自动识别：
- GoPro视频目录（`gopro_raw/`）
- PrimeColor视频（`primecolor_raw/Video.avi`）
- QR anchor视频（`qr_sync.mp4`）
- Mocap CSV文件（`mocap/video.csv`）

**文件**: [sync/sync_multi_camera_workflow.py](sync/sync_multi_camera_workflow.py)

### 步骤1: GoPro官方Timecode同步

使用GoPro嵌入的硬件timecode进行同步。

**原理**：
1. 使用ffprobe提取每个视频的timecode（格式：`HH:MM:SS:FF`）
2. 计算所有视频的公共时间窗口
3. 用ffmpeg裁剪到同步的时间段

**模式选择**：
- `fast_copy`: 最快（~1分钟），使用copy codec，关键帧精度（可能0-2秒误差）
- `ultrafast`: 快速且帧精确（~5-10分钟），libx264 ultrafast preset **（推荐默认）**
- `accurate`: 最慢但最高质量（~60分钟），libx264 medium preset

**文件**: [scripts/sync_timecode.py](scripts/sync_timecode.py)

**输出**：
- `gopro_synced/cam01/Video.MP4` (同步后的视频)
- `gopro_synced/cam02/Video.MP4`
- `gopro_synced/cam03/Video.MP4`
- `gopro_synced/cam04/Video.MP4`
- `gopro_synced/meta_info.json` (每个相机的offset和duration)

### 步骤2: GoPro同步质量验证（QR码）

扫描同步后GoPro视频的QR码，验证同步质量。

**方法**：
1. 扫描每个GoPro视频的开头30秒和结尾30秒
2. 检测QR码，计算帧间时间差
3. 评估同步质量：excellent / good / poor

**文件**: [sync/verify_gopro_sync_with_qr.py](sync/verify_gopro_sync_with_qr.py)

**输出**：
- `gopro_qr_verification.json` (验证结果)
- 包含每个相机的sync_quality和max_time_diff

### 步骤3: PrimeColor与GoPro同步 ⭐核心步骤⭐

使用QR anchor视频，将PrimeColor与同步后的GoPro对齐。

**核心算法（Anchor对齐法）**：

```
1. 扫描GoPro视频，检测QR码 → [(gopro_time, qr_num), ...]
2. 扫描PrimeColor视频，检测QR码 → [(primecolor_time, qr_num), ...]
3. 将每个检测映射到anchor时间：
   - gopro_offset = gopro_time - anchor_time(qr_num)
   - primecolor_offset = primecolor_time - anchor_time(qr_num)
4. 计算相对偏移：
   - offset = primecolor_offset_median - gopro_offset_median
5. 对齐视频：
   - 如果offset > 0: PrimeColor前面填充黑帧
   - 如果offset < 0: PrimeColor裁剪开头
```

**关键特点**：
- ✅ **不需要共同QR码**！每个视频单独与anchor对齐
- ✅ 支持不同FPS（通过fps_ratio自动处理）
- ✅ 使用中位数（robust to outliers）
- ✅ 自动计算时长重叠部分

**文件**: [sync/sync_primecolor_gopro.py](sync/sync_primecolor_gopro.py)

**关键代码片段**：
```python
# 计算每个视频相对anchor的offset
gopro_offsets = [vt - at for vt, at, qr in gopro_pairs]
primecolor_offsets = [vt - at for vt, at, qr in primecolor_pairs]

gopro_offset_median = np.median(gopro_offsets)
primecolor_offset_median = np.median(primecolor_offsets)

# 相对偏移（不需要共同QR码！）
offset = primecolor_offset_median - gopro_offset_median
fps_ratio = primecolor_fps / gopro_fps
```

**输出**：
- `primecolor_mocap_synced/primecolor_synced.mp4` (同步后的PrimeColor视频)
- `primecolor_mocap_synced/mocap_synced.csv` (同步后的Mocap数据)
- `primecolor_mocap_synced/sync_mapping.json` (映射参数)

**映射参数示例**：
```json
{
  "offset": -9.379,               // 时间偏移（秒）
  "offset_frames_primecolor": -1125,  // 帧偏移
  "fps_ratio": 2.002,            // FPS比例
  "gopro_offset_anchor": 7.712,  // GoPro相对anchor偏移
  "primecolor_offset_anchor": -1.667,  // PrimeColor相对anchor偏移
  "gopro_offset_std": 0.008,     // 一致性（标准差）
  "primecolor_offset_std": 0.008,
  "fit_quality": "anchor_alignment"
}
```

### 步骤4: 最终同步验证（视频结尾）

扫描所有视频的结尾部分，验证最终同步效果。

**文件**: [sync/verify_final_sync_all_cameras.py](sync/verify_final_sync_all_cameras.py)

### 步骤5: 生成堆叠视频

创建包含所有GoPro + PrimeColor的堆叠视频，用于可视化验证同步效果。

**支持的布局**：
- `horizontal`: 水平排列（一行，当前使用）
- `grid`: 网格布局（待实现自定义每行视频数）

**文件**: [sync/create_stacked_video.py](sync/create_stacked_video.py)

**输出**：
- `stacked_all_cameras.mp4` (堆叠视频)
- 包含4个GoPro + 1个PrimeColor = 5个视频水平排列

---

## 使用方法

### 方法1: 一键运行完整工作流程（推荐）

```bash
python sync/sync_multi_camera_workflow.py \
  --input_dir /path/to/data \
  --output_dir /path/to/output \
  --sync_mode ultrafast \
  --stacked
```

**参数说明**：
- `--input_dir`: 输入目录（包含gopro_raw, primecolor_raw, qr_sync.mp4, mocap等）
- `--output_dir`: 输出目录
- `--sync_mode`: 同步模式（fast_copy / ultrafast / accurate）
- `--stacked`: 是否生成堆叠视频
- `--videos_per_row`: 堆叠视频每行视频数（默认3，当前未实现）

### 方法2: 分步运行

```bash
# 步骤1: GoPro同步
python scripts/sync_timecode.py \
  --src_tag gopro_raw \
  --out_tag gopro_synced \
  --sync_mode ultrafast

# 步骤2: GoPro验证
python sync/verify_gopro_sync_with_qr.py \
  --gopro_dir gopro_synced \
  --anchor_video qr_sync.mp4

# 步骤3: PrimeColor同步
python sync/sync_primecolor_gopro.py \
  --gopro_video gopro_synced/cam04/Video.MP4 \
  --primecolor_video primecolor_raw/Video.avi \
  --anchor_video qr_sync.mp4 \
  --mocap_csv mocap/video.csv \
  --output_dir primecolor_synced

# 步骤5: 生成堆叠视频
python sync/create_stacked_video.py \
  --gopro_dir gopro_synced \
  --primecolor_video primecolor_synced/primecolor_synced.mp4 \
  --output stacked_output.mp4 \
  --layout horizontal
```

---

## 输出文件结构

```
output_dir/
├── gopro_synced/                  # 同步后的GoPro视频
│   ├── cam01/Video.MP4
│   ├── cam02/Video.MP4
│   ├── cam03/Video.MP4
│   ├── cam04/Video.MP4
│   └── meta_info.json            # 同步元数据
├── gopro_qr_verification.json    # GoPro同步验证结果
├── primecolor_mocap_synced/       # PrimeColor同步输出
│   ├── primecolor_synced.mp4     # 同步后的PrimeColor视频
│   ├── mocap_synced.csv          # 同步后的Mocap数据
│   └── sync_mapping.json         # 时间映射参数
├── final_verification.json        # 最终验证结果
├── stacked_all_cameras.mp4        # 堆叠视频（可选）
└── sync_workflow_report.json     # 完整工作流程报告
```

---

## 测试结果示例

### 同步质量
```
GoPro相对anchor偏移: 7.712s (标准差: 0.008s) ✅
PrimeColor相对anchor偏移: -1.667s (标准差: 0.008s) ✅
相对偏移: -9.379s (-1125帧 @ 120fps)
```

**一致性分析**：
- 标准差只有0.008秒（约1帧 @ 120fps）
- 说明QR码检测非常稳定！

### 输出视频信息
- GoPro同步视频: 90.23秒 @ 60fps（4个相机）
- PrimeColor同步视频: 66.18秒 @ 120fps（取重叠部分）
- 堆叠视频: 90.21秒 @ 240fps, 9600x1080 (5个视频水平排列)

---

## 核心修复说明

### 问题: PrimeColor与GoPro不同步

**原因**：
1. ❌ 旧代码尝试查找GoPro和PrimeColor的**共同QR码**
2. ❌ 当找不到共同QR码时，虽然会回退到anchor对齐，但实现有bug

### 解决方案: 完全移除共同QR码逻辑

参考 [sync/sync_with_qr_anchor.py](sync/sync_with_qr_anchor.py) 的正确实现：

**修改前** (错误逻辑):
```python
# 查找共同QR码
common_qrs = set(gopro_qrs) & set(primecolor_qrs)
if len(common_qrs) >= 3:
    # 使用least_squares优化
    ...
else:
    # 回退到anchor对齐（但有bug）
    ...
```

**修改后** (正确逻辑):
```python
# 直接使用anchor对齐，不需要共同QR码！
gopro_offset_median = np.median([vt - at for vt, at, qr in gopro_pairs])
primecolor_offset_median = np.median([vt - at for vt, at, qr in primecolor_pairs])
offset = primecolor_offset_median - gopro_offset_median
```

**关键点**：
- ✅ 每个视频单独与anchor对齐
- ✅ 通过anchor作为中介计算相对偏移
- ✅ 不需要两个视频看到相同的QR码

---

## 依赖要求

```bash
# Python包
pip install opencv-python numpy pandas scipy pyzbar

# 系统工具
- ffmpeg (用于视频处理)
- ffprobe (用于提取视频信息)
```

---

## 常见问题

### Q1: 为什么不需要共同QR码？
A: Anchor对齐法通过QR anchor视频作为"绝对时间基准"。每个相机独立与anchor对齐，然后通过anchor计算相对偏移。类比：两个人约会，不需要直接见面，只要都记录"相对约定时间的早/晚"即可计算偏移。

### Q2: 为什么PrimeColor视频比GoPro短？
A: 因为offset为负（PrimeColor需要裁剪开头9.38秒），裁剪后只剩66.18秒可用内容。输出时长取两个视频的重叠部分。

### Q3: 堆叠视频为什么是水平排列而不是网格？
A: 现有的`stack_videos_grid`函数硬编码为2x2布局（4个视频）。对于5个视频，目前使用水平排列。网格布局的自定义每行视频数功能待实现。

### Q4: sync_mode选哪个？
A: 推荐`ultrafast`（默认）- 快速且帧精确，性价比最高。

### Q5: 如何验证同步效果？
A: 查看`stacked_all_cameras.mp4`，对比5个视频的QR码是否对齐。

---

## 作者与更新

- 最后更新: 2025-11-04
- 核心修复: 移除共同QR码逻辑，改用纯anchor对齐
- 验证状态: ✅ 测试通过，同步精度 < 0.01秒

---

## 参考代码文件

### 核心文件
1. [sync/sync_multi_camera_workflow.py](sync/sync_multi_camera_workflow.py) - 主工作流程
2. [sync/sync_primecolor_gopro.py](sync/sync_primecolor_gopro.py) - PrimeColor同步（核心算法）
3. [sync/sync_with_qr_anchor.py](sync/sync_with_qr_anchor.py) - Anchor对齐参考实现
4. [scripts/sync_timecode.py](scripts/sync_timecode.py) - GoPro timecode同步
5. [sync/create_stacked_video.py](sync/create_stacked_video.py) - 堆叠视频生成

### 工具函数
- [utils/io_utils.py](utils/io_utils.py) - 视频堆叠工具（`stack_videos_horizontally`, `stack_videos_grid`）
- [sync/verify_gopro_sync_with_qr.py](sync/verify_gopro_sync_with_qr.py) - GoPro同步验证
- [sync/verify_final_sync_all_cameras.py](sync/verify_final_sync_all_cameras.py) - 最终验证
