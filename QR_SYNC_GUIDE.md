# QR码视频同步完整指南

## 概述

这套工具提供了基于帧编号QR码的视频同步方案，相比之前的方案有以下优势：

✅ **简单直接**：每个QR码=唯一的帧编号，无歧义
✅ **精度高**：支持不同FPS的视频（30fps vs 120fps）
✅ **验证完整**：开始+结束双检查点，自动检测时间漂移
✅ **格式通用**：支持mp4/avi/mov等多种视频格式
✅ **自动校准**：统一输出到参考视频的FPS和分辨率

## 工作流程

```
1. 生成QR码视频 (generate_qr_sync_video.py)
   ↓
2. 播放QR码视频，两个相机同时录制
   ↓
3. 运行同步脚本 (sync_with_qr_frames.py)
   ├─ 扫描开始部分 → 计算offset_start
   ├─ 扫描结束部分 → 计算offset_end
   ├─ 检测漂移 → |offset_end - offset_start|
   ├─ 创建同步视频 → 统一FPS和时长
   └─ 验证结果 → 确认对齐成功
```

## 步骤1: 生成QR码视频

### 基本用法

```bash
# 生成60秒、30fps的QR码视频
python generate_qr_sync_video.py --output qr_sync_30fps.mp4 --duration 60 --fps 30

# 生成120秒、60fps的QR码视频（用于长时间录制）
python generate_qr_sync_video.py --output qr_sync_60fps.mp4 --duration 120 --fps 60
```

### 高级选项

```bash
# 自定义分辨率（适配不同屏幕）
python generate_qr_sync_video.py \
    --output qr_sync.mp4 \
    --duration 60 \
    --fps 30 \
    --resolution 3840x2160  # 4K分辨率

# 使用QR码前缀（可选，增加识别鲁棒性）
python generate_qr_sync_video.py \
    --output qr_sync.mp4 \
    --duration 60 \
    --fps 30 \
    --prefix "SYNC-"  # QR码格式变为 "SYNC-000001", "SYNC-000002" ...

# 生成AVI格式（某些播放器更兼容）
python generate_qr_sync_video.py \
    --output qr_sync.avi \
    --duration 60 \
    --fps 30
```

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--output` | 输出视频路径 | **必需** |
| `--duration` | 视频时长（秒） | 60 |
| `--fps` | 帧率 | 30 |
| `--resolution` | 分辨率 (WxH) | 1920x1080 |
| `--qr-size` | QR码尺寸（像素） | 800 |
| `--prefix` | QR码前缀 | "" (空) |

### 输出示例

```
生成QR码同步视频
================================================================================
输出路径: qr_sync_30fps.mp4
时长: 60秒
帧率: 30 fps
分辨率: 1920x1080
QR码尺寸: 800px
================================================================================

开始生成 1800 帧...
  进度: 300/1800 (16.7%)
  进度: 600/1800 (33.3%)
  ...
✅ 初始视频生成完成
重新编码为高质量视频...
✅ 最终视频生成完成: qr_sync_30fps.mp4
文件大小: 12.34 MB
```

## 步骤2: 录制QR码视频

### 录制设置

1. **播放QR码视频**：
   - 使用高分辨率屏幕（笔记本/显示器/平板）
   - 全屏播放，确保QR码清晰可见
   - 建议在暗环境中播放（减少屏幕反光）

2. **相机设置**：
   - **GoPro**: 设置为需要的FPS（如60fps或120fps）
   - **PrimeColor**: 设置为需要的FPS（如30fps）
   - 两个相机可以使用**不同的FPS**（脚本会自动处理）
   - 确保两个相机都能清晰拍到QR码

3. **录制流程**：
   ```
   a. 同时按下两个相机的录制按钮（尽量同步，±1秒内都可以）
   b. 开始播放QR码视频（从第0秒开始）
   c. 录制至少60秒（覆盖完整的QR码序列）
   d. 继续录制你的实验内容...
   e. （可选）在视频快结束时，重新播放QR码视频一段时间
   f. 停止录制
   ```

### 最佳实践

- ✅ **开始时录制QR码**：前60秒录制QR码视频，用于计算初始offset
- ✅ **结束时再次录制QR码**：在视频结尾再录制60秒QR码，用于验证漂移
- ✅ **相机稳定**：使用三脚架，避免晃动导致QR码检测失败
- ✅ **距离适中**：相机距离屏幕1-2米，确保QR码在画面中心且清晰
- ⚠️ **避免过曝**：调整相机曝光，避免屏幕过亮导致QR码无法识别

## 步骤3: 运行同步脚本

### 基本用法

```bash
# 同步两个视频（自动检测漂移）
python sync_with_qr_frames.py \
    --video1 gopro.mp4 \
    --video2 primecolor.avi \
    --output primecolor_synced.mp4
```

### 高级用法

```bash
# 完整功能：同步+验证+生成对比视频
python sync_with_qr_frames.py \
    --video1 gopro.mp4 \
    --video2 primecolor.avi \
    --output primecolor_synced.mp4 \
    --stacked stacked_verify.mp4 \
    --save-json sync_data.json \
    --match-resolution  # 调整video2分辨率匹配video1

# 自定义扫描参数（如果你的QR码在不同位置）
python sync_with_qr_frames.py \
    --video1 gopro.mp4 \
    --video2 primecolor.avi \
    --output primecolor_synced.mp4 \
    --scan-start-duration 30 \  # 扫描前30秒
    --scan-end-duration 30 \    # 扫描后30秒
    --step 3                    # 每3帧检测一次（更密集）

# 如果生成QR码时使用了前缀
python sync_with_qr_frames.py \
    --video1 gopro.mp4 \
    --video2 primecolor.avi \
    --output primecolor_synced.mp4 \
    --prefix "SYNC-"
```

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--video1` | 参考视频（通常是GoPro） | **必需** |
| `--video2` | 待同步视频（通常是PrimeColor） | **必需** |
| `--output` | 输出同步后的video2 | **必需** |
| `--prefix` | QR码前缀（需与生成时一致） | "" |
| `--scan-start-duration` | 开始部分扫描时长（秒） | 60 |
| `--scan-end-duration` | 结束部分扫描时长（秒） | 60 |
| `--step` | 检测帧间隔 | 5 |
| `--drift-threshold` | 漂移阈值（秒） | 0.1 |
| `--stacked` | 输出stacked对比视频 | 无 |
| `--save-json` | 保存检测数据JSON | 无 |
| `--match-resolution` | 调整video2分辨率匹配video1 | false |

### 输出示例

```
基于帧编号QR码的视频同步工具（增强版）
================================================================================

视频信息:
  Video1: 180.00s @ 60.00fps, 1920x1080
  Video2: 185.50s @ 30.00fps, 1280x720
  ⚠️ 两个视频的FPS不同，将统一为video1的FPS: 60.00

================================================================================
步骤1: 扫描开始部分
================================================================================
扫描: gopro.mp4
  时间段: 0.0s - 60.0s
  视频信息: 60.00fps, 180.00s, 10800帧
  ✅ 检测到 1800 个唯一QR码 (扫描了720帧)

扫描: primecolor.avi
  时间段: 0.0s - 60.0s
  视频信息: 30.00fps, 185.50s, 5565帧
  ✅ 检测到 1800 个唯一QR码 (扫描了360帧)

  开始部分: 找到 1800 个公共QR码
    Offset统计:
      中位数: 2.3456s
      均值:   2.3458s
      标准差: 0.0023s
      范围:   [2.3401s, 2.3521s]

✅ 开始部分offset: 2.3456s

================================================================================
步骤2: 扫描结束部分（检测漂移）
================================================================================
扫描: gopro.mp4
  时间段: 120.0s - 180.0s
  ...
✅ 结束部分offset: 2.3461s

漂移检测:
  开始offset: 2.3456s
  结束offset: 2.3461s
  漂移量:     0.0005s
  ✅ 漂移在可接受范围内

================================================================================
步骤3: 创建同步视频
================================================================================
创建同步视频...
  目标: 180.00s @ 60.00fps
  输入: 185.50s @ 30.00fps, 1280x720
  方案: 从 2.346s 开始裁剪
  ✅ 创建完成

✅ 同步视频已保存: primecolor_synced.mp4

================================================================================
步骤4: 验证同步结果
================================================================================
扫描: primecolor_synced.mp4
  时间段: 120.0s - 180.0s
  ...
  验证（同步后）: 找到 1800 个公共QR码
    Offset统计:
      中位数: 0.0002s
      ...

验证结果:
  同步后offset: 0.0002s
  ✅ 验证成功！同步后视频对齐良好

================================================================================
✅ 完成！
================================================================================
同步视频: primecolor_synced.mp4
```

## 输出文件说明

### 1. 同步后的视频 (`--output`)

- **内容**：video2经过时间对齐和FPS转换后的视频
- **特性**：
  - 时长与video1相同
  - FPS与video1相同
  - 起始时间与video1对齐（基于QR码）
  - （可选）分辨率与video1相同

### 2. Stacked验证视频 (`--stacked`)

- **内容**：video1和同步后的video2并排显示
- **用途**：
  - 目视检查两个视频是否真的对齐
  - 验证QR码是否在相同时刻显示相同内容
  - 检查运动是否同步

### 3. 检测数据JSON (`--save-json`)

```json
{
  "video1": {
    "path": "gopro.mp4",
    "info": {"fps": 60.0, "duration": 180.0, ...},
    "detections_start": [[0.0, 1], [0.083, 2], ...],
    "detections_end": [[120.0, 3600], ...]
  },
  "video2": {...},
  "sync_results": {
    "offset_start": {"offset": 2.3456, "std": 0.0023, ...},
    "offset_end": {"offset": 2.3461, ...},
    "final_offset": 2.3456,
    "drift": 0.0005,
    "verify": {"offset": 0.0002, ...}
  }
}
```

## 故障排查

### 问题1: QR码检测失败

**现象**：
```
✅ 检测到 0 个唯一QR码
❌ 无法从开始部分计算同步偏移
```

**可能原因和解决方案**：

1. **QR码不清晰**：
   - 增加相机距离屏幕的距离
   - 调整相机对焦
   - 增大屏幕亮度
   - 使用更大的`--qr-size`重新生成QR码视频

2. **缺少pyzbar库**：
   ```bash
   pip install pyzbar
   ```

3. **QR码在视频画面外**：
   - 调整相机角度
   - 使用更大的屏幕

4. **视频损坏**：
   ```bash
   ffprobe -v error -show_entries stream=codec_name,width,height gopro.mp4
   ```

### 问题2: 检测到的QR码太少

**现象**：
```
❌ 公共QR码太少(2)
```

**解决方案**：

1. **减小帧间隔**：
   ```bash
   --step 3  # 从默认的5改为3，增加扫描密度
   ```

2. **增加扫描时长**：
   ```bash
   --scan-start-duration 90  # 从60秒增加到90秒
   ```

3. **检查录制时间**：
   - 确保两个相机都录制了完整的QR码视频片段
   - 检查是否有相机提前停止录制

### 问题3: 时间漂移过大

**现象**：
```
⚠️ 警告: 检测到时间漂移 (0.523s > 0.1s)
```

**可能原因和解决方案**：

1. **相机帧率不稳定**：
   - GoPro: 关闭HyperSmooth（防抖会影响帧率稳定性）
   - 使用固定帧率模式（非可变帧率VFR）

2. **录制中有丢帧**：
   - 检查SD卡速度（使用V30或更高等级）
   - 降低录制分辨率或码率
   - 检查存储空间是否充足

3. **录制被中断**：
   - 检查视频是否有明显的时间跳跃
   - 重新录制完整的视频

4. **两个相机晶振差异**（长时间录制）：
   - 这是正常的物理现象
   - 脚本会自动使用平均offset
   - 对于超过10分钟的录制，考虑在中间位置再次录制QR码

### 问题4: 同步后验证失败

**现象**：
```
⚠️ 验证异常：同步后仍有 0.345s 偏差
```

**可能原因和解决方案**：

1. **ffmpeg处理误差**：
   - 检查是否有警告信息
   - 尝试使用`-c:v copy`而非重新编码（仅适用于相同FPS）

2. **结束部分QR码质量差**：
   - 相机可能过热导致对焦漂移
   - 重新录制，确保整个过程中QR码清晰

3. **误检测**：
   - 查看`--save-json`输出的检测数据
   - 检查是否有异常的QR码编号

## 最佳实践总结

### 录制前准备

1. ✅ 生成足够长的QR码视频（至少60秒）
2. ✅ 使用高质量屏幕播放（分辨率≥1080p）
3. ✅ 调整屏幕亮度适中（70-80%）
4. ✅ 相机使用三脚架固定

### 录制过程

1. ✅ 两个相机尽量同时开始录制（±1秒内）
2. ✅ 从QR码视频的第0秒开始播放
3. ✅ 确保QR码在画面中心且清晰可见
4. ✅ 录制至少60秒的QR码序列
5. ✅ 完成实验录制后，再次录制60秒QR码（可选但推荐）

### 同步处理

1. ✅ 优先使用默认参数运行
2. ✅ 检查漂移检测结果
3. ✅ 生成stacked视频进行目视验证
4. ✅ 保存JSON数据用于调试

### 质量检查

1. ✅ 检查offset标准差（应< 0.01秒）
2. ✅ 检查漂移量（应< 0.1秒）
3. ✅ 观看stacked视频的QR码是否对齐
4. ✅ 验证offset应接近0（< 0.1秒）

## 依赖安装

```bash
# 核心依赖
pip install opencv-python numpy qrcode[pil]

# 可选依赖（加速QR码检测）
pip install pyzbar

# 系统依赖（macOS）
brew install zbar  # pyzbar的底层库

# 系统依赖（Ubuntu）
sudo apt-get install libzbar0
```

## 技术细节

### QR码编码格式

- **默认**: 6位数字（`000001` - `999999`），足够表示277小时@60fps
- **带前缀**: `SYNC-000001`，增加识别鲁棒性
- **纠错级别**: ERROR_CORRECT_H（最高级别），确保部分损坏也能识别

### 同步算法

1. **多点拟合**：使用所有匹配点的中位数，比单点更鲁棒
2. **异常值过滤**：使用IQR（四分位距）规则自动排除误检测
3. **FPS转换**：使用ffmpeg的`-r`参数，保证时间精度
4. **黑帧填充**：当video2晚于video1时，自动填充黑帧对齐

### 帧率处理

```python
# video1: 60fps, video2: 30fps
# QR码视频: 30fps（帧编号: 0, 1, 2, 3, ...）

# 同步后:
# - video1保持60fps
# - video2转换为60fps（每帧重复2次）
# - 两者时间轴对齐
```

## 参考

- QR码生成: [qrcode](https://pypi.org/project/qrcode/)
- QR码检测: [pyzbar](https://pypi.org/project/pyzbar/)
- 视频处理: [FFmpeg](https://ffmpeg.org/)
- OpenCV: [cv2.VideoCapture](https://docs.opencv.org/4.x/d8/dfe/classcv_1_1VideoCapture.html)
